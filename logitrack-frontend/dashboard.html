<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LogiTrack</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- Logo -->
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-box-seam me-2"></i>
                LogiTrack
            </a>

            <!-- Botón para móvil -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Links de navegación -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="bodegas.html">
                            <i class="bi bi-building me-1"></i>Bodegas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="productos.html">
                            <i class="bi bi-box me-1"></i>Productos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="movimientos.html">
                            <i class="bi bi-arrow-left-right me-1"></i>Movimientos
                        </a>
                    </li>
                </ul>

                <!-- Usuario y logout -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="userName">Usuario</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <span class="dropdown-item-text">
                                    <small class="text-muted" id="userEmail">usuario@ejemplo.com</small>
                                </span>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="logout()">
                                    <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container-fluid mt-4">
        
        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-1">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Dashboard
                </h2>
                <p class="text-muted">Resumen general del sistema</p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Cards de estadísticas -->
        <div class="row">
            
            <!-- Total Bodegas -->
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="mb-1">Total Bodegas</p>
                            <h3 class="text-primary" id="totalBodegas">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h3>
                            <small class="text-muted">Bodegas registradas</small>
                        </div>
                        <i class="bi bi-building text-primary"></i>
                    </div>
                </div>
            </div>

            <!-- Total Productos -->
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="stat-card" style="border-left-color: var(--success-color);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="mb-1">Total Productos</p>
                            <h3 class="text-success" id="totalProductos">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h3>
                            <small class="text-muted">Productos en catálogo</small>
                        </div>
                        <i class="bi bi-box text-success"></i>
                    </div>
                </div>
            </div>

            <!-- Stock Bajo -->
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="stat-card" style="border-left-color: var(--warning-color);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="mb-1">Stock Bajo</p>
                            <h3 class="text-warning" id="stockBajo">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h3>
                            <small class="text-muted">Productos con poco stock</small>
                        </div>
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                    </div>
                </div>
            </div>

            <!-- Total Movimientos -->
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="stat-card" style="border-left-color: var(--info-color);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="mb-1">Movimientos Hoy</p>
                            <h3 class="text-info" id="movimientosHoy">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h3>
                            <small class="text-muted">Entradas y salidas</small>
                        </div>
                        <i class="bi bi-arrow-left-right text-info"></i>
                    </div>
                </div>
            </div>

        </div>

        <!-- Últimos movimientos -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>
                            Últimos Movimientos
                        </h5>
                        <a href="movimientos.html" class="btn btn-sm btn-primary">
                            Ver todos
                            <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>

                    <!-- Tabla de movimientos -->
                    <div id="tableContainer">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos con stock bajo -->
        <div class="row mt-4 mb-4">
            <div class="col-12">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Productos con Stock Bajo
                        </h5>
                        <a href="productos.html" class="btn btn-sm btn-warning">
                            Ver todos
                            <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>

                    <!-- Tabla de productos -->
                    <div id="stockBajoContainer">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Scripts personalizados -->
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    
    <!-- Script del dashboard -->
    <script>
    // ============================================
    // DASHBOARD - LÓGICA PRINCIPAL
    // ============================================

    document.addEventListener('DOMContentLoaded', async () => {
        
        // Cargar estadísticas
        await loadStats();
        
        // Cargar últimos movimientos
        await loadRecentMovements();
        
        // Cargar productos con stock bajo
        await loadLowStock();
    });

    // ============================================
    // CARGAR ESTADÍSTICAS
    // ============================================

    async function loadStats() {
        try {
            // Cargar bodegas
            const bodegas = await bodegasAPI.getAll();
            document.getElementById('totalBodegas').textContent = bodegas.length;

            // Cargar productos
            const productos = await productosAPI.getAll();
            document.getElementById('totalProductos').textContent = productos.length;

            // Cargar productos con stock bajo (stock <= 50)
            const stockBajo = productos.filter(p => p.stock <= 50);
            document.getElementById('stockBajo').textContent = stockBajo.length;

            // Cargar movimientos (todos por ahora)
            const movimientos = await movimientosAPI.getAll();
            document.getElementById('movimientosHoy').textContent = movimientos.length;

        } catch (error) {
            console.error('Error cargando estadísticas:', error);
            document.getElementById('totalBodegas').textContent = '0';
            document.getElementById('totalProductos').textContent = '0';
            document.getElementById('stockBajo').textContent = '0';
            document.getElementById('movimientosHoy').textContent = '0';
        }
    }

    // ============================================
    // CARGAR ÚLTIMOS MOVIMIENTOS
    // ============================================

    async function loadRecentMovements() {
        const container = document.getElementById('tableContainer');
        
        try {
            const movimientos = await movimientosAPI.getAll();
            
            if (movimientos.length === 0) {
                showNoData('tableContainer', 'No hay movimientos registrados');
                return;
            }

            // Mostrar solo los últimos 5
            const ultimos = movimientos.slice(0, 5);

            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Fecha</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            ultimos.forEach(mov => {
                const tipoBadge = getTipoBadge(mov.tipoMovimiento || mov.tipo_movimiento);
                html += `
                    <tr>
                        <td>${tipoBadge}</td>
                        <td>${mov.producto?.nombre || 'Producto ID: ' + mov.producto_id}</td>
                        <td><strong>${formatNumber(mov.cantidad)}</strong></td>
                        <td><small>${formatDate(mov.fecha)}</small></td>
                        <td><small>${mov.observaciones || 'Sin observaciones'}</small></td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;

        } catch (error) {
            console.error('Error cargando movimientos:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    Error al cargar los movimientos: ${error.message}
                </div>
            `;
        }
    }

    // ============================================
    // CARGAR PRODUCTOS CON STOCK BAJO
    // ============================================

    async function loadLowStock() {
        const container = document.getElementById('stockBajoContainer');
        
        try {
            const productos = await productosAPI.getAll();
            
            // Filtrar productos con stock bajo (<=50)
            const stockBajo = productos.filter(p => p.stock <= 50);
            
            if (stockBajo.length === 0) {
                showNoData('stockBajoContainer', 'No hay productos con stock bajo');
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th>Stock Actual</th>
                                <th>Precio</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            stockBajo.forEach(prod => {
                html += `
                    <tr>
                        <td><strong>${prod.nombre}</strong></td>
                        <td>${prod.categoria || 'Sin categoría'}</td>
                        <td><span class="badge badge-warning">${formatNumber(prod.stock)}</span></td>
                        <td>${formatCurrency(prod.precio)}</td>
                        <td>
                            ${prod.activo 
                                ? '<span class="badge badge-success">Activo</span>' 
                                : '<span class="badge badge-danger">Inactivo</span>'}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;

        } catch (error) {
            console.error('Error cargando productos con stock bajo:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    Error al cargar los productos: ${error.message}
                </div>
            `;
        }
    }

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================

    function getTipoBadge(tipo) {
        const badges = {
            'ENTRADA': '<span class="badge badge-success">Entrada</span>',
            'SALIDA': '<span class="badge badge-danger">Salida</span>',
            'TRANSFERENCIA': '<span class="badge badge-info">Transferencia</span>'
        };
        return badges[tipo] || tipo;
    }
    </script>

</body>
</html>