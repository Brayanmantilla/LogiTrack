<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimientos - LogiTrack</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-box-seam me-2"></i>
                LogiTrack
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="bodegas.html">
                            <i class="bi bi-building me-1"></i>Bodegas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="productos.html">
                            <i class="bi bi-box me-1"></i>Productos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="movimientos.html">
                            <i class="bi bi-arrow-left-right me-1"></i>Movimientos
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="userName">Usuario</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <span class="dropdown-item-text">
                                    <small class="text-muted" id="userEmail">usuario@ejemplo.com</small>
                                </span>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="logout()">
                                    <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container-fluid mt-4">
        
        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h2 class="mb-1">
                    <i class="bi bi-arrow-left-right me-2"></i>
                    Gestión de Movimientos
                </h2>
                <p class="text-muted">Registra entradas, salidas y transferencias</p>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalMovimiento" onclick="openCreateModal()">
                    <i class="bi bi-plus-circle me-2"></i>
                    Nuevo Movimiento
                </button>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Filtros -->
        <div class="row mb-3">
            <div class="col-md-3">
                <select class="form-select" id="filterTipo" onchange="filterMovimientos()">
                    <option value="">Todos los tipos</option>
                    <option value="ENTRADA">Entradas</option>
                    <option value="SALIDA">Salidas</option>
                    <option value="TRANSFERENCIA">Transferencias</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filterBodega" onchange="filterMovimientos()">
                    <option value="">Todas las bodegas</option>
                    <!-- Se llenará dinámicamente -->
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" id="filterFecha" onchange="filterMovimientos()">
            </div>
            <div class="col-md-3">
                <button class="btn btn-secondary w-100" onclick="clearFilters()">
                    <i class="bi bi-x-circle me-2"></i>
                    Limpiar Filtros
                </button>
            </div>
        </div>

        <!-- Tabla de movimientos -->
        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <div id="tableContainer">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal para Crear Movimiento -->
    <div class="modal fade" id="modalMovimiento" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-arrow-left-right me-2"></i>
                        Nuevo Movimiento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formMovimiento">
                        
                        <div class="row">
                            <!-- Tipo de Movimiento -->
                            <div class="col-md-6 mb-3">
                                <label for="tipoMovimiento" class="form-label">Tipo de Movimiento *</label>
                                <select class="form-select" id="tipoMovimiento" required onchange="handleTipoChange()">
                                    <option value="">Seleccionar...</option>
                                    <option value="ENTRADA">Entrada (Ingreso a bodega)</option>
                                    <option value="SALIDA">Salida (Egreso de bodega)</option>
                                    <option value="TRANSFERENCIA">Transferencia (Entre bodegas)</option>
                                </select>
                            </div>

                            <!-- Producto -->
                            <div class="col-md-6 mb-3">
                                <label for="productoId" class="form-label">Producto *</label>
                                <select class="form-select" id="productoId" required>
                                    <option value="">Seleccionar...</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>

                            <!-- Bodega Origen -->
                            <div class="col-md-6 mb-3">
                                <label for="bodegaId" class="form-label">
                                    <span id="bodegaLabel">Bodega *</span>
                                </label>
                                <select class="form-select" id="bodegaId" required>
                                    <option value="">Seleccionar...</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>

                            <!-- Bodega Destino (solo para transferencias) -->
                            <div class="col-md-6 mb-3" id="bodegaDestinoContainer" style="display: none;">
                                <label for="bodegaDestinoId" class="form-label">Bodega Destino *</label>
                                <select class="form-select" id="bodegaDestinoId">
                                    <option value="">Seleccionar...</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>

                            <!-- Cantidad -->
                            <div class="col-md-6 mb-3">
                                <label for="cantidad" class="form-label">Cantidad *</label>
                                <input type="number" class="form-control" id="cantidad" required min="1" placeholder="0">
                            </div>

                            <!-- Observaciones -->
                            <div class="col-12 mb-3">
                                <label for="observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="observaciones" rows="2" placeholder="Observaciones del movimiento (opcional)"></textarea>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnGuardar" onclick="saveMovimiento()">
                        <i class="bi bi-check-circle me-2"></i>
                        Registrar Movimiento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Scripts personalizados -->
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    
    <!-- Script de movimientos -->
    <script>
        // ============================================
        // MOVIMIENTOS - LÓGICA PRINCIPAL
        // ============================================

        let modalMovimiento;
        let allMovimientos = [];
        let bodegas = [];
        let productos = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializar modal
            modalMovimiento = new bootstrap.Modal(document.getElementById('modalMovimiento'));
            
            // Cargar datos iniciales
            await loadInitialData();
            
            // Cargar movimientos
            await loadMovimientos();
        });

        // ============================================
        // CARGAR DATOS INICIALES
        // ============================================

        async function loadInitialData() {
            try {
                // Cargar bodegas
                bodegas = await bodegasAPI.getActivas();
                
                // Cargar productos
                productos = await productosAPI.getActivos();
                
                // Llenar selects del modal
                fillBodegasSelect();
                fillProductosSelect();
                
                // Llenar filtro de bodegas
                fillBodegasFilter();
                
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showErrorAlert('Error al cargar datos iniciales');
            }
        }

        // ============================================
        // LLENAR SELECTS
        // ============================================

        function fillBodegasSelect() {
            const selectOrigen = document.getElementById('bodegaId');
            const selectDestino = document.getElementById('bodegaDestinoId');
            
            let html = '<option value="">Seleccionar...</option>';
            bodegas.forEach(bodega => {
                html += `<option value="${bodega.id}">${bodega.nombre}</option>`;
            });
            
            selectOrigen.innerHTML = html;
            selectDestino.innerHTML = html;
        }

        function fillProductosSelect() {
            const select = document.getElementById('productoId');
            
            let html = '<option value="">Seleccionar...</option>';
            productos.forEach(producto => {
                html += `<option value="${producto.id}">${producto.nombre} (Stock: ${producto.stockActual})</option>`;
            });
            
            select.innerHTML = html;
        }

        function fillBodegasFilter() {
            const select = document.getElementById('filterBodega');
            
            let html = '<option value="">Todas las bodegas</option>';
            bodegas.forEach(bodega => {
                html += `<option value="${bodega.id}">${bodega.nombre}</option>`;
            });
            
            select.innerHTML = html;
        }

        // ============================================
        // MANEJAR CAMBIO DE TIPO
        // ============================================

        function handleTipoChange() {
            const tipo = document.getElementById('tipoMovimiento').value;
            const bodegaDestinoContainer = document.getElementById('bodegaDestinoContainer');
            const bodegaLabel = document.getElementById('bodegaLabel');
            const bodegaDestinoSelect = document.getElementById('bodegaDestinoId');
            
            if (tipo === 'TRANSFERENCIA') {
                bodegaDestinoContainer.style.display = 'block';
                bodegaLabel.textContent = 'Bodega Origen *';
                bodegaDestinoSelect.required = true;
            } else {
                bodegaDestinoContainer.style.display = 'none';
                bodegaLabel.textContent = 'Bodega *';
                bodegaDestinoSelect.required = false;
                bodegaDestinoSelect.value = '';
            }
        }

        // ============================================
        // CARGAR MOVIMIENTOS
        // ============================================

        async function loadMovimientos() {
            const container = document.getElementById('tableContainer');
            
            try {
                showLoading('tableContainer');
                
                allMovimientos = await movimientosAPI.getAll();
                
                if (allMovimientos.length === 0) {
                    showNoData('tableContainer', 'No hay movimientos registrados');
                    return;
                }

                renderMovimientos(allMovimientos);

            } catch (error) {
                console.error('Error cargando movimientos:', error);
                showErrorAlert('Error al cargar los movimientos');
            }
        }

        // ============================================
        // RENDERIZAR MOVIMIENTOS
        // ============================================

        function renderMovimientos(movimientos) {
            const container = document.getElementById('tableContainer');

            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tipo</th>
                                <th>Producto</th>
                                <th>Bodega Origen</th>
                                <th>Bodega Destino</th>
                                <th>Cantidad</th>
                                <th>Fecha</th>
                                <th>Usuario</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            movimientos.forEach(mov => {
                const tipoBadge = getTipoBadge(mov.tipoMovimiento);
                
                html += `
                    <tr>
                        <td><strong>#${mov.id}</strong></td>
                        <td>${tipoBadge}</td>
                        <td><strong>${mov.producto?.nombre || 'N/A'}</strong></td>
                        <td>${mov.bodega?.nombre || 'N/A'}</td>
                        <td>${mov.bodegaDestino?.nombre || '-'}</td>
                        <td><strong class="text-primary">${formatNumber(mov.cantidad)}</strong></td>
                        <td><small>${formatDate(mov.fechaMovimiento)}</small></td>
                        <td><small>${mov.usuario?.nombre || 'N/A'}</small></td>
                        <td><small>${truncateText(mov.observaciones || 'Sin observaciones', 30)}</small></td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // ============================================
        // FILTRAR MOVIMIENTOS
        // ============================================

        function filterMovimientos() {
            const filterTipo = document.getElementById('filterTipo').value;
            const filterBodega = document.getElementById('filterBodega').value;
            const filterFecha = document.getElementById('filterFecha').value;

            let filtered = allMovimientos;

            // Filtrar por tipo
            if (filterTipo) {
                filtered = filtered.filter(m => m.tipoMovimiento === filterTipo);
            }

            // Filtrar por bodega
            if (filterBodega) {
                filtered = filtered.filter(m => 
                    m.bodega?.id == filterBodega || m.bodegaDestino?.id == filterBodega
                );
            }

            // Filtrar por fecha
            if (filterFecha) {
                filtered = filtered.filter(m => {
                    const fechaMov = new Date(m.fechaMovimiento).toISOString().split('T')[0];
                    return fechaMov === filterFecha;
                });
            }

            renderMovimientos(filtered);
        }

        // ============================================
        // LIMPIAR FILTROS
        // ============================================

        function clearFilters() {
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterBodega').value = '';
            document.getElementById('filterFecha').value = '';
            renderMovimientos(allMovimientos);
        }

        // ============================================
        // ABRIR MODAL CREAR
        // ============================================

        function openCreateModal() {
            document.getElementById('formMovimiento').reset();
            handleTipoChange();
        }

        // ============================================
        // GUARDAR MOVIMIENTO
        // ============================================

        async function saveMovimiento() {
            const form = document.getElementById('formMovimiento');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const tipoMovimiento = document.getElementById('tipoMovimiento').value;
            const productoId = parseInt(document.getElementById('productoId').value);
            const bodegaId = parseInt(document.getElementById('bodegaId').value);
            const cantidad = parseInt(document.getElementById('cantidad').value);
            const observaciones = document.getElementById('observaciones').value.trim();

            const movimiento = {
                tipoMovimiento,
                productoId,
                bodegaId,
                cantidad,
                observaciones: observaciones || null
            };

            // Si es transferencia, agregar bodega destino
            if (tipoMovimiento === 'TRANSFERENCIA') {
                const bodegaDestinoId = parseInt(document.getElementById('bodegaDestinoId').value);
                
                if (!bodegaDestinoId) {
                    showErrorAlert('Debe seleccionar una bodega destino para transferencias');
                    return;
                }
                
                if (bodegaDestinoId === bodegaId) {
                    showErrorAlert('La bodega origen y destino no pueden ser la misma');
                    return;
                }
                
                movimiento.bodegaDestinoId = bodegaDestinoId;
            }

            try {
                showButtonLoading('btnGuardar', 'Registrando...');

                await movimientosAPI.create(movimiento);
                showSuccessAlert('Movimiento registrado exitosamente');

                modalMovimiento.hide();
                form.reset();
                await loadMovimientos();
                await loadInitialData(); // Recargar para actualizar stocks

            } catch (error) {
                console.error('Error guardando movimiento:', error);
                showErrorAlert(error.message || 'Error al registrar el movimiento');
            } finally {
                hideButtonLoading('btnGuardar');
            }
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================

        function getTipoBadge(tipo) {
            const badges = {
                'ENTRADA': '<span class="badge badge-success"><i class="bi bi-arrow-down-circle me-1"></i>Entrada</span>',
                'SALIDA': '<span class="badge badge-danger"><i class="bi bi-arrow-up-circle me-1"></i>Salida</span>',
                'TRANSFERENCIA': '<span class="badge badge-info"><i class="bi bi-arrow-left-right me-1"></i>Transferencia</span>'
            };
            return badges[tipo] || tipo;
        }

    </script>

</body>
</html>